\tikzstyle{large container node}=[
minimum width=45mm,
node distance=7mm and 0mm,
%draw=red,
]

\tikzstyle{medium container node}=[
minimum width=14mm,
node distance=7mm and 0mm,
%draw=green,
]

\tikzstyle{small container node}=[
minimum width=5.5mm,
node distance=7mm and 0mm,
%draw=blue,
]

\tikzstyle{my block node}=[
block node,
text width=4cm,
]

\tikzstyle{my arrow style}=[
arrow style,
shorten <= 1mm,
shorten >= 1mm,
]

\tikzstyle{my caption node}=[
inner sep=0mm,
text width=5.3cm,
align=right,
font=\bfseries,
%draw,
]

\tikzstyle{large gap}=[
node distance=15mm and 0mm,
]

\colorlet{h1color}{red!90!black}
\colorlet{h2color}{green!80!black}

\node[large container node] (cx1) {};
\node[large container node, right=of cx1] (cx2) {};

\node[data node] (x1) at (cx1) {$x_1$};
\node[data node] (x2) at (cx2) {$x_2$};


\node[medium container node, above=of x1] (c2l1) {};
\node[medium container node, left=of c2l1] (c1l1) {};
\node[medium container node, right=of c2l1] (c3l1) {};

\node[my block node, color 1, above=of cx1] (l1) {Linear};
\node[my block node, color 1, above=of cx2] (l2) {Linear};

\draw[my arrow style] (cx1) to (l1);
\draw[my arrow style] (cx2) to (l2);

\node[medium container node, above=of l1] (ck1) {};
\node[medium container node, left=of ck1] (cq1) {};
\node[medium container node, right=of ck1] (cv1) {};
\node[medium container node, above=of l2] (ck2) {};
\node[medium container node, left=of ck2] (cq2) {};
\node[medium container node, right=of ck2] (cv2) {};

\node[data node] at (cq1) (q1) {$q_1$};
\node[data node] at (ck1) (k1) {$k_1$};
\node[data node] at (cv1) (v1) {$v_1$};
\node[data node] at (cq2) (q2) {$q_2$};
\node[data node] at (ck2) (k2) {$k_2$};
\node[data node] at (cv2) (v2) {$v_2$};

\draw[arrow style] (l1.north-|cq1) to (cq1.south);
\draw[arrow style] (l1.north-|ck1) to (ck1.south);
\draw[arrow style] (l1.north-|cv1) to (v1.south);
\draw[arrow style] (l2.north-|cq2) to (cq2);
\draw[arrow style] (l2.north-|ck2) to (ck2);
\draw[arrow style] (l2.north-|cv2) to (cv2);

\node[small container node, above=of cq1, anchor=east] (cq1h1) {};
\node[small container node, above=of cq1, anchor=west] (cq1h2) {};
\node[small container node, above=of ck1, anchor=east] (ck1h1) {};
\node[small container node, above=of ck1, anchor=west] (ck1h2) {};
\node[small container node, above=of cv1, anchor=east] (cv1h1) {};
\node[small container node, above=of cv1, anchor=west] (cv1h2) {};
\node[small container node, above=of cq2, anchor=east] (cq2h1) {};
\node[small container node, above=of cq2, anchor=west] (cq2h2) {};
\node[small container node, above=of ck2, anchor=east] (ck2h1) {};
\node[small container node, above=of ck2, anchor=west] (ck2h2) {};
\node[small container node, above=of cv2, anchor=east] (cv2h1) {};
\node[small container node, above=of cv2, anchor=west] (cv2h2) {};

\node[data node] (q1h1) at (cq1h1) {$q_{1_{ \textcolor{h1color}{h1} }}$};
\node[data node] (q1h2) at (cq1h2) {$q_{1_{ \textcolor{h2color}{h2} }}$};
\node[data node] (k1h1) at (ck1h1) {$k_{1_{ \textcolor{h1color}{h1} }}$};
\node[data node] (k1h2) at (ck1h2) {$k_{1_{ \textcolor{h2color}{h2} }}$};
\node[data node] (v1h1) at (cv1h1) {$v_{1_{ \textcolor{h1color}{h1} }}$};
\node[data node] (v1h2) at (cv1h2) {$v_{1_{ \textcolor{h2color}{h2} }}$};
\node[data node] (q2h1) at (cq2h1) {$q_{2_{ \textcolor{h1color}{h1} }}$};
\node[data node] (q2h2) at (cq2h2) {$q_{2_{ \textcolor{h2color}{h2} }}$};
\node[data node] (k2h1) at (ck2h1) {$k_{2_{ \textcolor{h1color}{h1} }}$};
\node[data node] (k2h2) at (ck2h2) {$k_{2_{ \textcolor{h2color}{h2} }}$};
\node[data node] (v2h1) at (cv2h1) {$v_{2_{ \textcolor{h1color}{h1} }}$};
\node[data node] (v2h2) at (cv2h2) {$v_{2_{ \textcolor{h2color}{h2} }}$};

\draw[arrow style] (cq1) to (cq1h1);
\draw[arrow style] (cq1) to (cq1h2);
\draw[arrow style] (ck1) to (ck1h1);
\draw[arrow style] (ck1) to (ck1h2);
\draw[arrow style] (cv1) to (cv1h1);
\draw[arrow style] (cv1) to (cv1h2);
\draw[arrow style] (cq2) to (cq2h1);
\draw[arrow style] (cq2) to (cq2h2);
\draw[arrow style] (ck2) to (ck2h1);
\draw[arrow style] (ck2) to (ck2h2);
\draw[arrow style] (cv2) to (cv2h1);
\draw[arrow style] (cv2) to (cv2h2);

\node[small container node, large gap, above=of cq1h1] (cq1h1s) {};
\node[small container node, large gap, above=of cq1h2] (cq2h1s) {};
\node[small container node, large gap, above=of ck1h1] (ck1h1s) {};
\node[small container node, large gap, above=of ck1h2] (ck2h1s) {};
\node[small container node, large gap, above=of cv1h1] (cv1h1s) {};
\node[small container node, large gap, above=of cv1h2] (cv2h1s) {};
\node[small container node, large gap, above=of cq2h1] (cq1h2s) {};
\node[small container node, large gap, above=of cq2h2] (cq2h2s) {};
\node[small container node, large gap, above=of ck2h1] (ck1h2s) {};
\node[small container node, large gap, above=of ck2h2] (ck2h2s) {};
\node[small container node, large gap, above=of cv2h1] (cv1h2s) {};
\node[small container node, large gap, above=of cv2h2] (cv2h2s) {};

\node[data node, large gap] (q1h1s) at (cq1h1s) {$q_{1_{ \textcolor{h1color}{h1} }}$};
\node[data node, large gap] (q2h1s) at (cq2h1s) {$q_{2_{ \textcolor{h1color}{h1} }}$};
\node[data node, large gap] (k1h1s) at (ck1h1s) {$k_{1_{ \textcolor{h1color}{h1} }}$};
\node[data node, large gap] (k2h1s) at (ck2h1s) {$k_{2_{ \textcolor{h1color}{h1} }}$};
\node[data node, large gap] (v1h1s) at (cv1h1s) {$v_{1_{ \textcolor{h1color}{h1} }}$};
\node[data node, large gap] (v2h1s) at (cv2h1s)  {$v_{2_{ \textcolor{h1color}{h1} }}$};
\node[data node, large gap] (q1h2s) at (cq1h2s)  {$q_{1_{ \textcolor{h2color}{h2} }}$};
\node[data node, large gap] (q2h2s) at (cq2h2s) {$q_{2_{ \textcolor{h2color}{h2} }}$};
\node[data node, large gap] (k1h2s) at (ck1h2s) {$k_{1_{ \textcolor{h2color}{h2} }}$};
\node[data node, large gap] (k2h2s) at (ck2h2s) {$k_{2_{ \textcolor{h2color}{h2} }}$};
\node[data node, large gap] (v1h2s) at (cv1h2s) {$v_{1_{ \textcolor{h2color}{h2} }}$};
\node[data node, large gap] (v2h2s) at (cv2h2s) {$v_{2_{ \textcolor{h2color}{h2} }}$};

\draw[arrow style, h1color] (cq1h1.north) to (cq1h1s.south);
\draw[arrow style, h2color] (cq1h2.north) to (cq1h2s.south);
\draw[arrow style, h1color] (ck1h1.north) to (ck1h1s.south);
\draw[arrow style, h2color] (ck1h2.north) to (ck1h2s.south);
\draw[arrow style, h1color] (cv1h1.north) to (cv1h1s.south);
\draw[arrow style, h2color] (cv1h2.north) to (cv1h2s.south);
\draw[arrow style, h1color] (cq2h1.north) to (cq2h1s.south);
\draw[arrow style, h2color] (cq2h2.north) to (cq2h2s.south);
\draw[arrow style, h1color] (ck2h1.north) to (ck2h1s.south);
\draw[arrow style, h2color] (ck2h2.north) to (ck2h2s.south);
\draw[arrow style, h1color] (cv2h1.north) to (cv2h1s.south);
\draw[arrow style, h2color] (cv2h2.north) to (cv2h2s.south);


\node[fit node, fit=(cq1h1s)(ck1h1s)(cv2h1s)] (h1fit) {};
\node[fit node, fit=(cq1h2s)(ck1h2s)(cv2h2s)] (h2fit) {};

\node[my block node, color 2, above=of h1fit] (attn1) {Scaled Dot-product \\ attention};
\node[my block node, color 2, above=of h2fit] (attn2) {Scaled Dot-product \\ attention};

\draw[arrow style] (cq1h1s) to (cq1h1s|-attn1.south);
\draw[arrow style] (cq2h1s) to (cq2h1s|-attn1.south);
\draw[arrow style] (ck1h1s) to (ck1h1s|-attn1.south);
\draw[arrow style] (ck2h1s) to (ck2h1s|-attn1.south);
\draw[arrow style] (cv1h1s) to (cv1h1s|-attn1.south);
\draw[arrow style] (cv2h1s) to (cv2h1s|-attn1.south);
\draw[arrow style] (cq1h2s) to (cq1h2s|-attn1.south);
\draw[arrow style] (cq2h2s) to (cq2h2s|-attn1.south);
\draw[arrow style] (ck1h2s) to (ck1h2s|-attn1.south);
\draw[arrow style] (ck2h2s) to (ck2h2s|-attn1.south);
\draw[arrow style] (cv1h2s) to (cv1h2s|-attn1.south);
\draw[arrow style] (cv2h2s) to (cv2h2s|-attn1.south);

\node[medium container node, above=of attn1, anchor=east] (ca1h1) {};
\node[medium container node, above=of attn1, anchor=west] (ca2h1) {};
\node[medium container node, above=of attn2, anchor=east] (ca1h2) {};
\node[medium container node, above=of attn2, anchor=west] (ca2h2) {};

\node [data node] (a1h1) at (ca1h1) {$a_{1_{h1}}$};
\node [data node] (a2h1) at (ca2h1) {$a_{2_{h1}}$};
\node [data node] (a1h2) at (ca1h2) {$a_{1_{h2}}$};
\node [data node] (a2h2) at (ca2h2) {$a_{2_{h2}}$};

\draw[my arrow style] (attn1.north-|ca1h1) to ( ca1h1);
\draw[my arrow style] (attn1.north-|ca2h1) to ( ca2h1);
\draw[my arrow style] (attn1.north-|ca1h2) to ( ca1h2);
\draw[my arrow style] (attn1.north-|ca2h2) to ( ca2h2);

\node[medium container node, above=of ca1h1] (ca1h1s) {};
\node[medium container node, above=of ca1h2] (ca2h1s) {};
\node[medium container node, above=of ca2h1] (ca1h2s) {};
\node[medium container node, above=of ca2h2] (ca2h2s) {};

\node[data node] (a1h1s) at (ca1h1s) {$a_{1_{h1}}$};
\node[data node] (a1h2s) at (ca1h2s) {$a_{1_{h2}}$};
\node[data node] (a2h1s) at (ca2h1s) {$a_{2_{h1}}$};
\node[data node] (a2h2s) at (ca2h2s) {$a_{2_{h2}}$};

\draw[my arrow style] (ca1h1) to (ca1h1s);
\draw[my arrow style] (ca1h2) to (ca1h2s);
\draw[my arrow style] (ca2h1) to (ca2h1s);
\draw[my arrow style] (ca2h2) to (ca2h2s);

\node[medium container node, large gap, above=of ca1h1s.east] (ca1) {};
\node[medium container node, large gap, above=of ca2h1s.east] (ca2) {};

\node[data node] (a1) at (ca1) {$a_1$};
\node[data node] (a2) at (ca2) {$a_2$};

\draw[my arrow style] (ca1h1s) to (ca1);
\draw[my arrow style] (ca1h2s) to (ca1);
\draw[my arrow style] (ca2h1s) to (ca2);
\draw[my arrow style] (ca2h2s) to (ca2);


\node[my block node, color 3, above=of ca1] (ll1) {Linear};
\node[my block node, color 3, above=of ca2] (ll2) {Linear};

\draw[my arrow style] (ca1) to (ll1);
\draw[my arrow style] (ca2) to (ll2);

\node[medium container node, above=of ll1] (cy1) {};
\node[medium container node, above=of ll2] (cy2) {};

\node[data node] (y1) at (cy1) {$y_1$};
\node[data node] (y2) at (cy2) {$y_2$};

\draw[my arrow style] (ll1) to (cy1);
\draw[my arrow style] (ll2) to (cy2);

\coordinate (dalign) at ($(l1.west) - (2mm, 0mm)$);
\node[my caption node, anchor=east] at (dalign) {Apply linear transform $W_{q}$ to each input vector $x_i$ to get query, key, and value vectors};
\coordinate (q1mid) at ($(q1)!0.5!(q1h1)$);
\node[my caption node, anchor=east] at (dalign|-q1mid) {Split vectors into parts ("attention heads") of equal size};
\coordinate (sortmid) at ($(q1h1)!0.5!(q1h1s)$);
\node[my caption node, anchor=east]  at (dalign|-sortmid) {Group vectors first by head, then type, then position};
\node[my caption node, anchor=east]  at (dalign|-attn1) {Compute attention outputs for each head using Scaled Dot-product attention};
\coordinate (a1h1mid) at ($(a1h1)!0.5!(a1h1s)$);
\node[my caption node, anchor=east]  at (dalign|-a1h1mid) {Group attention outputs first by position, then head};
\coordinate (a1h1smid) at ($(a1h1s)!0.5!(a1)$);
\node[my caption node, anchor=east]  at (dalign|-a1h1smid) {Concatenate heads for each attention output position};
\node[my caption node, anchor=east]  at (dalign|-ll1) {Apply linear transform \\ $\mathbf{W}_\mathrm{proj}, \mathbf{b}_\mathrm{proj}$};